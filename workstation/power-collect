#!/bin/sh

set -e

MQTT=$(which mosquitto_pub)
TOPIC=sensors

[ -n "$MQTTUSER" ] || { echo "export MQTT username as MQTTUSER" >&2 ; exit 1 ; }
[ -n "$MQTTPASS" ] || { echo "export MQTT password as MQTTPASS" >&2 ; exit 1 ; }

while true ; do
  # these require root, ugh--set powercap-info suid root, or something similar =\.
  UPSW=$(pwrstat -status | grep Load | cut -d\  -f2) || UPSW=""
  if [ -n "$UPSW" ] ; then
    "$MQTT" -t "$TOPIC/upswatts" -m "{\"upswatts\":$UPSW}" -u "$MQTTUSER" -P "$MQTTPASS"
  else
    echo "couldn't read UPS power" >&2
  fi
  #CORE1W=$(powercap-info -z 0:0 intel-rapl | grep energy_uj | cut -d: -f2 | tr -d [:space:])
  #sleep 1
  #CORE2W=$(powercap-info -z 0:0 intel-rapl | grep energy_uj | cut -d: -f2 | tr -d [:space:])
  #COREW=`jq -n \($CORE2W-$CORE1W\)/100000`
  #"$MQTT" -t "$TOPIC/corewatts" -m "{\"corewatts\":$COREW}" -u "$MQTTUSER" -P "$MQTTPASS"
  while :
  do
    PKG1W=$(powercap-info -z 0: intel-rapl | grep energy_uj | cut -d: -f2 | tr -d [:space:])
    sleep 1
    PKG2W=$(powercap-info -z 0: intel-rapl | grep energy_uj | cut -d: -f2 | tr -d [:space:])
    if [ $PKG2W -ge $PKG1W ] ; then
      PKGW=`jq -n \($PKG2W-$PKG1W\)/1000000`
      "$MQTT" -t "$TOPIC/pkgwatts" -m "{\"pkgwatts\":$PKGW}" -u "$MQTTUSER" -P "$MQTTPASS"
      break
    else
      echo "powercap went backwards $PKG1W $PKG2W" >&2
    fi
  done

  sleep 10
done
